# Copyright Contributors to the KubeOpenCode project

name: Auto-merge Bot PRs

on:
  # Merge when CI completes on bot PRs
  workflow_run:
    workflows: ["PR"]
    types: [completed]
  # Trigger on approval for kubeopencode-dev PRs
  pull_request_review:
    types: [submitted]
  # Manual trigger for batch processing
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auto-merge bot PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          merge_pr() {
            local pr_number=$1
            local pr_title=$2

            echo "Enabling auto-merge for PR #$pr_number: $pr_title"

            # Enable auto-merge - GitHub will merge when all requirements are met
            if gh pr merge "$pr_number" --auto --squash --delete-branch; then
              echo "Auto-merge enabled for PR #$pr_number"
            else
              echo "Failed to enable auto-merge for PR #$pr_number"
            fi
          }

          # Handle workflow_run event (CI completed)
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Only process successful CI runs
            if [ "${{ github.event.workflow_run.conclusion }}" != "success" ]; then
              echo "CI did not succeed, skipping"
              exit 0
            fi

            HEAD_BRANCH="${{ github.event.workflow_run.head_branch }}"
            PR_INFO=$(gh pr list --head "$HEAD_BRANCH" --state open --json number,author,title --jq '.[0] // empty')

            if [ -z "$PR_INFO" ]; then
              echo "No open PR found for branch: $HEAD_BRANCH"
              exit 0
            fi

            PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
            AUTHOR=$(echo "$PR_INFO" | jq -r '.author.login')
            TITLE=$(echo "$PR_INFO" | jq -r '.title')

            echo "Processing PR #$PR_NUMBER by $AUTHOR"

            # Dependabot: merge immediately (no approval required)
            if [[ "$AUTHOR" == "dependabot[bot]" ]]; then
              merge_pr "$PR_NUMBER" "$TITLE"
              exit 0
            fi

            # kubeopencode-dev: only merge if approved
            if [[ "$AUTHOR" == "kubeopencode-dev[bot]" ]]; then
              APPROVED=$(gh pr view "$PR_NUMBER" --json reviews --jq '[.reviews[] | select(.state == "APPROVED")] | length > 0')
              if [ "$APPROVED" = "true" ]; then
                merge_pr "$PR_NUMBER" "$TITLE"
              else
                echo "kubeopencode-dev PR not approved, skipping"
              fi
              exit 0
            fi

            echo "Not a bot PR, skipping"
            exit 0
          fi

          # Handle pull_request_review event (approval)
          if [ "${{ github.event_name }}" = "pull_request_review" ]; then
            if [ "${{ github.event.review.state }}" != "approved" ]; then
              echo "Not an approval, skipping"
              exit 0
            fi

            PR_NUMBER=${{ github.event.pull_request.number }}
            AUTHOR="${{ github.event.pull_request.user.login }}"
            TITLE="${{ github.event.pull_request.title }}"

            # Only process kubeopencode-dev PRs on approval
            if [[ "$AUTHOR" == "kubeopencode-dev[bot]" ]]; then
              echo "kubeopencode-dev PR approved, checking CI status..."

              # Check if all checks passed
              CHECKS_PASSED=$(gh pr view "$PR_NUMBER" --json statusCheckRollup --jq '[.statusCheckRollup[] | select(.conclusion != "SUCCESS" and .conclusion != "NEUTRAL" and .conclusion != "SKIPPED" and .conclusion != null and .name != "auto-merge")] | length == 0')

              if [ "$CHECKS_PASSED" = "true" ]; then
                merge_pr "$PR_NUMBER" "$TITLE"
              else
                echo "CI checks not passed yet, will merge when CI completes"
              fi
            fi
            exit 0
          fi

          # workflow_dispatch: batch process all open bot PRs
          echo "Batch processing all open bot PRs..."

          # Dependabot PRs: merge all with passing checks
          echo "Processing Dependabot PRs..."
          gh pr list --author "app/dependabot" --state open --json number,title,statusCheckRollup | jq -c '.[] | select([.statusCheckRollup[] | select(.conclusion != "SUCCESS" and .conclusion != "NEUTRAL" and .conclusion != "SKIPPED" and .conclusion != null and .name != "auto-merge")] | length == 0)' | while read -r pr; do
            number=$(echo "$pr" | jq -r '.number')
            title=$(echo "$pr" | jq -r '.title')
            merge_pr "$number" "$title"
          done

          # kubeopencode-dev PRs: merge approved ones with passing checks
          echo "Processing kubeopencode-dev PRs..."
          gh pr list --author "app/kubeopencode-dev" --state open --json number,title,reviews,statusCheckRollup | jq -c '.[] | select([.reviews[] | select(.state == "APPROVED")] | length > 0) | select([.statusCheckRollup[] | select(.conclusion != "SUCCESS" and .conclusion != "NEUTRAL" and .conclusion != "SKIPPED" and .conclusion != null and .name != "auto-merge")] | length == 0)' | while read -r pr; do
            number=$(echo "$pr" | jq -r '.number')
            title=$(echo "$pr" | jq -r '.title')
            merge_pr "$number" "$title"
          done

          echo "Batch processing complete"
