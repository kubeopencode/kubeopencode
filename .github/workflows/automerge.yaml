# Copyright Contributors to the KubeOpenCode project

name: Auto-merge Bot PRs

on:
  # Enable auto-merge when a bot PR is opened or updated
  pull_request:
    types: [opened, synchronize, reopened]
  # Trigger on approval for kubeopencode-dev PRs
  pull_request_review:
    types: [submitted]
  # Manual trigger for batch enabling auto-merge on existing PRs
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auto-merge bot PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine which PRs to process
          if [ "${{ github.event_name }}" = "pull_request" ] || [ "${{ github.event_name }}" = "pull_request_review" ]; then
            PR_NUMBER=${{ github.event.pull_request.number }}
            AUTHOR="${{ github.event.pull_request.user.login }}"

            echo "Processing PR #$PR_NUMBER by $AUTHOR"

            # Dependabot: enable auto-merge immediately (no approval required)
            if [[ "$AUTHOR" == "dependabot[bot]" ]]; then
              echo "Dependabot PR - enabling auto-merge (no approval required)..."
              gh pr merge "$PR_NUMBER" --auto --squash --delete-branch
              exit 0
            fi

            # kubeopencode-dev: only merge if approved
            if [[ "$AUTHOR" == "kubeopencode-dev[bot]" ]]; then
              # Check if PR has been approved
              APPROVED=$(gh pr view "$PR_NUMBER" --json reviews --jq '[.reviews[] | select(.state == "APPROVED")] | length > 0')
              if [ "$APPROVED" = "true" ]; then
                echo "kubeopencode-dev PR is approved - enabling auto-merge..."
                gh pr merge "$PR_NUMBER" --auto --squash --delete-branch
              else
                echo "kubeopencode-dev PR is not yet approved, skipping auto-merge"
              fi
              exit 0
            fi

            echo "Not a bot PR, skipping"
            exit 0
          fi

          # workflow_dispatch: batch process all open bot PRs
          echo "Batch processing all open bot PRs..."

          # Dependabot PRs: enable auto-merge for all
          echo "Processing Dependabot PRs..."
          gh pr list --author "app/dependabot" --state open --json number --jq '.[].number' | while read -r number; do
            echo "Enabling auto-merge for Dependabot PR #$number"
            gh pr merge "$number" --auto --squash --delete-branch || echo "Failed for PR #$number"
          done

          # kubeopencode-dev PRs: only if approved
          echo "Processing kubeopencode-dev PRs..."
          gh pr list --author "app/kubeopencode-dev" --state open --json number,reviews --jq '.[] | select([.reviews[] | select(.state == "APPROVED")] | length > 0) | .number' | while read -r number; do
            echo "Enabling auto-merge for approved kubeopencode-dev PR #$number"
            gh pr merge "$number" --auto --squash --delete-branch || echo "Failed for PR #$number"
          done

          echo "Batch processing complete"
