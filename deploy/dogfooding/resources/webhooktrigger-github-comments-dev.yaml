apiVersion: kubetask.io/v1alpha1
kind: WebhookTrigger
metadata:
  name: github-comments-dev
spec:
  auth:
    hmac:
      secretRef:
        name: github-webhook-secret
        key: hmacKey
      signatureHeader: X-Hub-Signature-256
      algorithm: sha256
  filter: |
    // Exclude kubetask bot to avoid infinite loops
    body.sender.login != "kubetask[bot]" &&
    // Only allow repo admins/owners to trigger dev tasks
    // author_association indicates the sender's permission level:
    // OWNER, MEMBER, COLLABORATOR, CONTRIBUTOR, FIRST_TIMER, FIRST_TIME_CONTRIBUTOR, NONE
    (
      (has(body.comment) && body.comment.author_association in ["OWNER", "MEMBER"]) ||
      (has(body.issue) && body.issue.author_association in ["OWNER", "MEMBER"]) ||
      (has(body.pull_request) && body.pull_request.author_association in ["OWNER", "MEMBER"]) ||
      (has(body.discussion) && body.discussion.author_association in ["OWNER", "MEMBER"])
    ) &&
    (
      // Issue comment  @kubetask-dev
      (headers["x-github-event"] == "issue_comment" &&
       body.action == "created" &&
       body.comment.body.contains("@kubetask-dev")) ||

      // PR review comment @kubetask-dev
      (headers["x-github-event"] == "pull_request_review_comment" &&
       body.action == "created" &&
       body.comment.body.contains("@kubetask-dev")) ||

      // Discussion comment @kubetask-dev
      (headers["x-github-event"] == "discussion_comment" &&
       body.action == "created" &&
       body.comment.body.contains("@kubetask-dev")) ||

      // Issue's body @kubetask-dev
      (headers["x-github-event"] == "issues" &&
       body.action in ["opened", "edited"] &&
       body.issue.body.contains("@kubetask-dev")) ||

      // PR's body @kubetask-dev
      (headers["x-github-event"] == "pull_request" &&
       body.action in ["opened", "edited"] &&
       body.pull_request.body.contains("@kubetask-dev")) ||

      // Discussion's body @kubetask-dev
      (headers["x-github-event"] == "discussion" &&
       body.action in ["created", "edited"] &&
       body.discussion.body.contains("@kubetask-dev"))
    )
  taskTemplate:
    agentRef: dev
    description: |
      GitHub 上有人 @kubetask-dev 请求帮助:

      Event: {{ index .headers "x-github-event" }}
      Repo: {{ .repository.full_name }}
      Sender: {{ .sender.login }}

      {{- if .comment }}
      Comment: {{ .comment.body }}
      URL: {{ .comment.html_url }}
      {{- else if .issue }}
      Issue #{{ .issue.number }}: {{ .issue.title }}
      Body: {{ .issue.body }}
      URL: {{ .issue.html_url }}
      {{- else if .pull_request }}
      PR #{{ .pull_request.number }}: {{ .pull_request.title }}
      Body: {{ .pull_request.body }}
      URL: {{ .pull_request.html_url }}
      {{- else if .discussion }}
      Discussion: {{ .discussion.title }}
      Body: {{ .discussion.body }}
      URL: {{ .discussion.html_url }}
      {{- end }}

---
