apiVersion: kubetask.io/v1alpha1
kind: WebhookTrigger
metadata:
  name: github-comments
spec:
  auth:
    hmac:
      secretRef:
        name: github-webhook-secret
        key: hmacKey
      signatureHeader: X-Hub-Signature-256
      algorithm: sha256
  filter: |
    // Exclude kubetask bot to avoid infinite loops
    body.sender.login != "kubetask[bot]" &&
    (
      // Issue comment  @kubetask
      (headers["x-github-event"] == "issue_comment" &&
       body.action == "created" &&
       body.comment.body.contains("@kubetask")) ||

      // PR review comment @kubetask
      (headers["x-github-event"] == "pull_request_review_comment" &&
       body.action == "created" &&
       body.comment.body.contains("@kubetask")) ||

      // Discussion comment @kubetask
      (headers["x-github-event"] == "discussion_comment" &&
       body.action == "created" &&
       body.comment.body.contains("@kubetask")) ||

      // Issue's body @kubetask
      (headers["x-github-event"] == "issues" &&
       body.action in ["opened", "edited"] &&
       body.issue.body.contains("@kubetask")) ||

      // PR's body @kubetask
      (headers["x-github-event"] == "pull_request" &&
       body.action in ["opened", "edited"] &&
       body.pull_request.body.contains("@kubetask")) ||

      // Discussion's body @kubetask
      (headers["x-github-event"] == "discussion" &&
       body.action in ["created", "edited"] &&
       body.discussion.body.contains("@kubetask"))
    )
  taskTemplate:
    agentRef: default
    description: |
      GitHub 上有人 @kubetask 请求帮助:

      Event: {{ index .headers "x-github-event" }}
      Repo: {{ .repository.full_name }}
      Sender: {{ .sender.login }}

      {{- if .comment }}
      Comment: {{ .comment.body }}
      URL: {{ .comment.html_url }}
      {{- else if .issue }}
      Issue #{{ .issue.number }}: {{ .issue.title }}
      Body: {{ .issue.body }}
      URL: {{ .issue.html_url }}
      {{- else if .pull_request }}
      PR #{{ .pull_request.number }}: {{ .pull_request.title }}
      Body: {{ .pull_request.body }}
      URL: {{ .pull_request.html_url }}
      {{- else if .discussion }}
      Discussion: {{ .discussion.title }}
      Body: {{ .discussion.body }}
      URL: {{ .discussion.html_url }}
      {{- end }}

---
