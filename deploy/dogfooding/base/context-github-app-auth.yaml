# Copyright Contributors to the KubeTask project
# Context for GitHub App authentication - instructions for agents
apiVersion: kubetask.io/v1alpha1
kind: Context
metadata:
  name: github-app-auth
  labels:
    app.kubernetes.io/name: kubetask
spec:
  type: Text
  text: |
    # GitHub Operations

    ## Quick Reference

    Two scripts are available at `${WORKSPACE_DIR}/.github-app/`:

    | Script | Purpose |
    |--------|---------|
    | `github.sh` | High-level operations (push, PR) - **use this for common tasks** |
    | `github-app-iat.sh` | Generate token for custom `gh` commands |

    ## Common Tasks (Recommended)

    **Note**: Use `bash` to execute scripts (avoids permission issues):

    ### Push and Create PR (One Command)

    ```bash
    bash ${WORKSPACE_DIR}/.github-app/github.sh push-and-pr <branch> "<title>" "[body]"
    ```

    Example:
    ```bash
    bash ${WORKSPACE_DIR}/.github-app/github.sh push-and-pr feature-branch "feat: add new feature" "Description here"
    ```

    ### Push Only

    ```bash
    bash ${WORKSPACE_DIR}/.github-app/github.sh push <branch>
    ```

    ### Create PR Only (branch must already be pushed)

    ```bash
    bash ${WORKSPACE_DIR}/.github-app/github.sh pr <branch> "<title>" "[body]"
    ```

    ## Custom GitHub Commands

    For commands not covered by `github.sh`, generate a token first:

    ```bash
    export GH_TOKEN=$(bash ${WORKSPACE_DIR}/.github-app/github-app-iat.sh \
      "$(cat /etc/github-app/client_id)" \
      /etc/github-app/private_key \
      "$(cat /etc/github-app/installation_id)")

    # Now use any gh command
    gh issue create --title "Bug report" --body "Description"
    gh pr comment 123 --body "LGTM!"
    gh api repos/{owner}/{repo}/issues
    ```

    **IMPORTANT**: Token generation and usage MUST be in the SAME shell command (connected with `&&`),
    because each tool call runs in a separate shell session.

    ## Troubleshooting

    ### Permission Denied Error

    If you see "Permission denied" when running scripts, fix permissions first:

    ```bash
    chmod +x ${WORKSPACE_DIR}/.github-app/*.sh
    ```

    Or use `bash` prefix (recommended - no permission needed):

    ```bash
    bash ${WORKSPACE_DIR}/.github-app/github.sh push-and-pr ...
    ```

    ### Script Path Issues

    Always use the documented symlink path, not physical paths with timestamps:

    - **Correct**: `${WORKSPACE_DIR}/.github-app/github.sh`
    - **Wrong**: `/workspace/.github-app/..2025_12_21.../github.sh`

    ## Notes

    - Tokens are valid for 1 hour
    - Scripts auto-detect repository from `git remote -v`
    - Credentials are at `/etc/github-app/` (client_id, installation_id, private_key)
    - Never echo or log token values
