# Copyright Contributors to the KubeOpenCode project
# Agent configuration for AI agent with credentials
apiVersion: kubeopencode.io/v1alpha1
kind: Agent
metadata:
  name: default
spec:
  agentImage: quay.io/kubeopencode/kubeopencode-agent-opencode:latest
  executorImage: quay.io/kubeopencode/kubeopencode-agent-devbox:latest
  workspaceDir: /workspace
  command:
    - sh
    - -c
    - /tools/opencode run "$(cat ${WORKSPACE_DIR}/task.md)"
  serviceAccountName: kubeopencode-agent
  maxConcurrentTasks: 3
  credentials:
    # Mount entire secret - all keys become env vars automatically
    - name: git
      secretRef:
        name: git-settings
    - name: opencode
      secretRef:
        name: opencode-credentials
    # GitHub App credentials mounted as directory
    # The devbox image has built-in scripts that automatically use these
    # for transparent gh CLI and git authentication
    - name: github-app
      secretRef:
        name: github-app-credentials
      mountPath: /etc/github-app
  # Agent-level contexts (lowest priority, applied to all tasks)
  contexts:
    - type: Text
      text: |
          ## Temporary Files

          **Do NOT use `/tmp` directory** - some AI agents have sandbox restrictions that prevent reading files outside the workspace.

          Create temporary files **WITHIN the Git repository directory** (not in `${WORKSPACE_DIR}` root):

          ```bash
          # Correct: Create temp files inside the Git repo
          cd ${WORKSPACE_DIR}/kubeopencode  # Your repo's mountPath
          mkdir -p .tmp
          echo "some-value" > .tmp/my-temp-file
          # Later read: cat .tmp/my-temp-file

          # Wrong: Creating temp files in workspace root
          # echo "value" > ${WORKSPACE_DIR}/branch_name  # May cause path confusion!
          ```

          **Why inside the Git repo?** The Agent typically operates within the repo directory. Files created at `${WORKSPACE_DIR}/` level may be inaccessible when working inside a subdirectory.
