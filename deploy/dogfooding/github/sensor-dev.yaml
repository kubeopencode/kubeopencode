# Copyright Contributors to the KubeOpenCode project
# Sensor that creates KubeOpenCode Tasks in response to @kubeopencode-dev mentions.
#
# This sensor handles privileged users (OWNER, MEMBER, CONTRIBUTOR, COLLABORATOR)
# and uses the dev agent which has GitHub content write permissions.
#
# The sensor handles ALL comment types where @kubeopencode-dev is mentioned:
# - Issue comments
# - PR comments (issue-level)
# - PR review comments (inline)
# - Discussion comments
#
# IMPORTANT: This sensor requires BOTH:
# 1. @kubeopencode-dev mention in comment body
# 2. Commenter must be a privileged user (OWNER, MEMBER, CONTRIBUTOR, COLLABORATOR)
apiVersion: argoproj.io/v1alpha1
kind: Sensor
metadata:
  name: github-dev-mentions
spec:
  eventBusName: default
  template:
    serviceAccountName: argo-events-sensor
  dependencies:
    - name: dev-mention
      eventSourceName: github-dev
      eventName: kubeopencode
      filters:
        # Filter for comment events with @kubeopencode-dev mention from privileged users
        # All filters use AND logic by default
        data:
          - path: body.action
            type: string
            value:
              - created
          - path: body.comment.body
            type: string
            value:
              # Regex pattern to match @kubeopencode-dev anywhere in text
              - ".*@kubeopencode-dev.*"
          # Exclude bot's own comments to prevent recursive triggers
          # Use body.sender.login which is consistent across all GitHub event types
          - path: body.sender.login
            type: string
            comparator: "!="
            value:
              - kubeopencode-bot[bot]
              - kubeopencode-dev[bot]
          - path: body.comment.author_association
            type: string
            value:
              - OWNER
              - MEMBER
              - CONTRIBUTOR
              - COLLABORATOR
  triggers:
    - template:
        name: dev-mention
        conditions: dev-mention
        k8s:
          operation: create
          source:
            resource:
              apiVersion: kubeopencode.io/v1alpha1
              kind: Task
              metadata:
                generateName: github-dev-mention-
                labels: {}
                annotations: {}
              spec:
                agentRef:
                  name: dev
                  namespace: kubeopencode-dogfooding
                description: ""
          parameters:
            # Labels for filtering
            - src:
                dependencyName: dev-mention
                dataTemplate: "{{ index (index .Input.headers \"X-Github-Event\") 0 }}"
              dest: metadata.labels.github\.kubeopencode\.io/event
            - src:
                dependencyName: dev-mention
                dataTemplate: "{{ .Input.body.repository.name }}"
              dest: metadata.labels.github\.kubeopencode\.io/repository
            - src:
                dependencyName: dev-mention
                dataTemplate: "{{ if .Input.body.issue }}{{ .Input.body.issue.number }}{{ else if .Input.body.pull_request }}{{ .Input.body.pull_request.number }}{{ else if .Input.body.discussion }}{{ .Input.body.discussion.number }}{{ end }}"
              dest: metadata.labels.github\.kubeopencode\.io/number
            # Annotations for detailed info
            - src:
                dependencyName: dev-mention
                dataTemplate: "{{ .Input.body.action }}"
              dest: metadata.annotations.github\.kubeopencode\.io/action
            - src:
                dependencyName: dev-mention
                dataTemplate: "{{ .Input.body.repository.full_name }}"
              dest: metadata.annotations.github\.kubeopencode\.io/full-name
            - src:
                dependencyName: dev-mention
                dataTemplate: "{{ .Input.body.comment.user.login }}"
              dest: metadata.annotations.github\.kubeopencode\.io/author
            - src:
                dependencyName: dev-mention
                dataTemplate: "{{ .Input.body.comment.html_url }}"
              dest: metadata.annotations.github\.kubeopencode\.io/url
            # Description
            - src:
                dependencyName: dev-mention
                dataTemplate: |
                  # GitHub Event: @kubeopencode-dev Mention (Privileged User)

                  ## Event Type
                  - GitHub Event: {{ index (index .Input.headers "X-Github-Event") 0 }}
                  - Action: {{ .Input.body.action }}

                  ## Repository
                  - Full Name: {{ .Input.body.repository.full_name }}
                  - Clone URL: {{ .Input.body.repository.clone_url }}
                  - Owner: {{ .Input.body.repository.owner.login }}
                  - Name: {{ .Input.body.repository.name }}

                  {{ if .Input.body.issue }}
                  ## Issue/PR Context
                  - Number: {{ .Input.body.issue.number }}
                  - Title: {{ .Input.body.issue.title }}
                  - URL: {{ .Input.body.issue.html_url }}
                  - State: {{ .Input.body.issue.state }}
                  {{ if .Input.body.issue.pull_request }}
                  - Type: Pull Request
                  {{ else }}
                  - Type: Issue
                  {{ end }}
                  {{ end }}

                  {{ if .Input.body.pull_request }}
                  ## Pull Request Context
                  - Number: {{ .Input.body.pull_request.number }}
                  - Title: {{ .Input.body.pull_request.title }}
                  - URL: {{ .Input.body.pull_request.html_url }}
                  {{ end }}

                  {{ if .Input.body.discussion }}
                  ## Discussion Context
                  - Number: {{ .Input.body.discussion.number }}
                  - Title: {{ .Input.body.discussion.title }}
                  - URL: {{ .Input.body.discussion.html_url }}
                  - Category: {{ .Input.body.discussion.category.name }}
                  {{ end }}

                  {{ if .Input.body.comment.path }}
                  ## Review Comment Location
                  - File: {{ .Input.body.comment.path }}
                  - Line: {{ .Input.body.comment.line }}
                  {{ end }}

                  ## Comment
                  - Author: {{ .Input.body.comment.user.login }}
                  - Author Association: {{ .Input.body.comment.author_association }}
                  - URL: {{ .Input.body.comment.html_url }}

                  ### Body
                  {{ .Input.body.comment.body }}

                  ---
                  **Instructions**:
                  {{ if .Input.body.discussion }}
                  Follow `.instructions/comment-discussion.md`
                  {{ else if .Input.body.comment.path }}
                  Follow `.instructions/comment-pr-review.md`
                  {{ else if .Input.body.issue.pull_request }}
                  Follow `.instructions/comment-pr.md`
                  {{ else if .Input.body.issue }}
                  Follow `.instructions/comment-issue.md`
                  {{ else }}
                  Follow `.instructions/comment.md`
                  {{ end }}

                  Use the following variables in commands:
                  - REPO={{ .Input.body.repository.full_name }}
                  - CLONE_URL={{ .Input.body.repository.clone_url }}
                  - OWNER={{ .Input.body.repository.owner.login }}
                  - REPO_NAME={{ .Input.body.repository.name }}
                  {{ if .Input.body.issue }}
                  - NUMBER={{ .Input.body.issue.number }}
                  {{ else if .Input.body.pull_request }}
                  - NUMBER={{ .Input.body.pull_request.number }}
                  {{ else if .Input.body.discussion }}
                  - NUMBER={{ .Input.body.discussion.number }}
                  {{ end }}
                  - COMMENTER={{ .Input.body.comment.user.login }}
                  {{ if .Input.body.comment.path }}
                  - FILE_PATH={{ .Input.body.comment.path }}
                  - LINE={{ .Input.body.comment.line }}
                  {{ end }}
              dest: spec.description
