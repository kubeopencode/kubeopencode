# Copyright Contributors to the KubeOpenCode project
# CronWorkflow that checks for OpenCode updates and creates a PR if needed.
#
# This workflow runs weekly on Monday at 9:00 AM UTC and creates a Task that:
# 1. Checks the latest OpenCode release on GitHub
# 2. Compares with the current version in agents/opencode/Dockerfile
# 3. Updates the Dockerfile if a new version is available
# 4. Creates a PR with the version bump
#
# Prerequisites:
# 1. Argo Workflows installed
# 2. base resources applied (Agent, ConfigMaps, Secrets)
# 3. RBAC permissions for cross-namespace Task creation
apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: opencode-update
  labels:
    app.kubernetes.io/name: kubeopencode
    app.kubernetes.io/component: scheduled
    app.kubernetes.io/part-of: dogfooding
spec:
  # Weekly on Monday at 9:00 AM UTC
  schedule: "0 9 * * 1"
  # Keep last 3 successful and 3 failed workflows for debugging
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  # Timezone for the schedule (defaults to UTC)
  timezone: "UTC"
  # Concurrency policy: don't start new if previous is still running
  concurrencyPolicy: "Forbid"
  # Workflow template
  workflowSpec:
    serviceAccountName: argo-workflow-executor
    # Clean up completed workflows after 7 days
    ttlStrategy:
      secondsAfterCompletion: 604800
      secondsAfterSuccess: 604800
      secondsAfterFailure: 604800
    # Timeout for the entire workflow (1 hour max)
    activeDeadlineSeconds: 3600
    entrypoint: create-update-task
    templates:
      - name: create-update-task
        resource:
          action: create
          # Fail the workflow if Task creation fails
          failureCondition: status.phase == Failed
          # Succeed when Task completes
          successCondition: status.phase == Completed
          # Manifest for the KubeOpenCode Task
          manifest: |
            apiVersion: kubeopencode.io/v1alpha1
            kind: Task
            metadata:
              generateName: opencode-update-
              namespace: kubeopencode-dogfooding
              labels:
                app.kubernetes.io/name: kubeopencode
                app.kubernetes.io/component: dependency-update
                app.kubernetes.io/part-of: dogfooding
                kubeopencode.io/scheduled: "true"
              annotations:
                kubeopencode.io/triggered-by: "CronWorkflow/opencode-update"
            spec:
              agentRef:
                name: refactor
                namespace: kubeopencode-dogfooding
              description: |
                # OpenCode Version Update Task

                ## Objective

                Check if there is a new release of OpenCode and update the Dockerfile
                if a newer version is available.

                ## Instructions

                1. Navigate to the cloned `kubeopencode` directory
                2. Check the current OpenCode version in `agents/opencode/Dockerfile`
                   - Look for the line `ARG OPENCODE_VERSION=x.y.z`
                3. Check the latest OpenCode release on GitHub:
                   ```bash
                   curl -s https://api.github.com/repos/anomalyco/opencode/releases/latest | jq -r '.tag_name'
                   ```
                4. Compare versions:
                   - If the GitHub version (without 'v' prefix) is newer than the Dockerfile version, proceed
                   - If versions are the same, exit successfully with message "OpenCode is already up to date"
                5. If update needed:
                   - Update the `ARG OPENCODE_VERSION=x.y.z` line in `agents/opencode/Dockerfile`
                   - Create a new branch: `chore/bump-opencode-<version>`
                   - Commit with message: `chore(agents): bump opencode version to <version>`
                   - Use signoff flag: `git commit -s`
                   - Push the branch and create a PR

                ## Important

                - Only update if there is actually a newer version
                - Do not make any other changes to the file
                - Use the exact version number from the GitHub release (without 'v' prefix)

                ## Context

                - Trigger: Scheduled CronWorkflow (weekly on Monday at 9:00 UTC)
                - Repository: kubeopencode/kubeopencode
                - File to update: agents/opencode/Dockerfile
